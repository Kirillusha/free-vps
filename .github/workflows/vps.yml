name: free-vps
on: [workflow_dispatch]  # Ð—Ð°Ð¿ÑƒÑÐº Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

jobs:
  deploy:
    runs-on: ubuntu-latest  # 2 ÑÐ´Ñ€Ð°, 7GB RAM, Ubuntu 22.04
    steps:
      - name: Setup SSH Server
        run: |
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ SSH-ÑÐµÑ€Ð²ÐµÑ€
          sudo apt-get update
          sudo apt-get install -y openssh-server

          # ÐœÐµÐ½ÑÐµÐ¼ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ root
          echo "root:MySuperSecretPassword123" | sudo chpasswd

          # Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ Ð²Ñ…Ð¾Ð´ root Ð¿Ð¾ Ð¿Ð°Ñ€Ð¾Ð»ÑŽ
          sudo sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config

          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ SSH
          sudo service ssh start

          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Serveo Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
          sudo apt-get install -y curl
          curl -s http://localhost:8080 > /dev/null 2>&1 &  # Ð—Ð°Ð³Ð»ÑƒÑˆÐºÐ° Ð´Ð»Ñ Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°

      - name: Create Public Tunnel with Serveo
        run: |
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Serveo â€” Ð¿Ñ€Ð¾Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾Ñ€Ñ‚ 22 Ð½Ð° Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ URL
          ssh -R 80:localhost:22 serveo.net 2>&1 | tee tunnel.log &
          sleep 10

          # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ URL
          URL=$(grep -oP 'https?://\S+\.serveo\.net' tunnel.log | head -1)
          if [ -z "$URL" ]; then
            echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ."
            exit 1
          fi

          # Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
          echo "âœ… VPS ÐÐšÐ¢Ð˜Ð’Ð•Ð!"
          echo "ðŸŒ ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ URL: $URL"
          echo "ðŸ‘¤ Ð›Ð¾Ð³Ð¸Ð½: root"
          echo "ðŸ”‘ ÐŸÐ°Ñ€Ð¾Ð»ÑŒ: MySuperSecretPassword123"
          echo "â³ Ð¡ÐµÑ€Ð²ÐµÑ€ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ 6 Ñ‡Ð°ÑÐ¾Ð²."

          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚
          echo "URL=$URL" > connection.txt
          echo "LOGIN=root" >> connection.txt
          echo "PASSWORD=MySuperSecretPassword123" >> connection.txt

      - name: Upload Connection Info
        uses: actions/upload-artifact@v3
        with:
          name: vps-connection
          path: connection.txt
